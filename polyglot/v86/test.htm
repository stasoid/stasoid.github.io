<!doctype html>

<script src="libv86.js"></script>
<script src="../util.js"></script>

<script>
let bin = "https://raw.githubusercontent.com/stasoid/polyglot-v86-binaries/main/";
onload = function()
{
	emulator = new V86Starter({
		wasm_path: bin + "v86.wasm",
		bios:      { url: bin + "seabios.bin" },
		vga_bios:  { url: bin + "vgabios.bin" },
		bzimage:   { url: bin + "buildroot-bzimage.bin" },
		filesystem: { basefs: bin + "mnt/fs.json", baseurl: bin + "mnt/" },
		screen_container: screen_container,
		autostart: true
	});

	let data = "";
	emulator.add_listener("serial0-output-char", ch => {
		data += ch;
		if(data.endsWith("~% ")) on_linux_booted();
		else if(data.endsWith("mnt% ")) on_command_finished();  // all commands are executed in /mnt
	});
}

function on_linux_booted()
{
	console.log("on_linux_booted");
	let data = new TextEncoder().encode(readfile("../346.txt"));
	emulator.create_file("f", data);
	emulator.serial0_send("cd /mnt\nsh install\n");
}

function on_command_finished()
{
	console.log("on_command_finished");
}

function v86_run(cmd, onfinish)
{
}

</script>

<!-- A minimal structure for the ScreenAdapter defined in browser/screen.js -->
<div id=screen_container>
	<div style="white-space: pre; font: 14px monospace"></div>
	<canvas></canvas>
</div>
